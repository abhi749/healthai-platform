<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthAI - Privacy-First Health Document Analysis</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .build-info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.1);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            background: white;
            border-radius: 15px 15px 0 0;
            overflow: hidden;
            margin-bottom: 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .tab-button {
            flex: 1;
            padding: 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-button.active {
            background: white;
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-button:hover {
            background: #e9ecef;
        }

        .tab-button.active:hover {
            background: white;
        }

        /* Main Content Area */
        .main-content {
            background: white;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            min-height: 600px;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        /* Document History Tab Styles */
        .documents-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .documents-title {
            font-size: 1.8rem;
            color: #333;
            font-weight: 700;
        }

        .upload-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
        }

        /* Documents Table */
        .documents-table-container {
            background: #f8f9fa;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .documents-table {
            width: 100%;
            border-collapse: collapse;
        }

        .documents-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 1rem;
        }

        .documents-table td {
            padding: 18px 15px;
            border-bottom: 1px solid #dee2e6;
            vertical-align: middle;
        }

        .documents-table tbody tr {
            transition: background-color 0.2s ease;
        }

        .documents-table tbody tr:hover {
            background: #e8f2ff;
        }

        .documents-table tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        .documents-table tbody tr:nth-child(even):hover {
            background: #e8f2ff;
        }

        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-processed {
            background: #d4edda;
            color: #155724;
        }

        .status-processing {
            background: #fff3cd;
            color: #856404;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        /* Action Buttons */
        .action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            margin: 0 3px;
            transition: all 0.2s ease;
        }

        .action-btn.view {
            background: #e3f2fd;
            color: #1976d2;
        }

        .action-btn.delete {
            background: #ffebee;
            color: #d32f2f;
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }

        /* Health Records Tab Styles */
        .records-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .records-title {
            font-size: 1.8rem;
            color: #333;
            font-weight: 700;
        }

        .analyze-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .analyze-btn:hover {
            transform: translateY(-2px);
        }

        .analyze-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        /* Health Records Filters */
        .records-filters {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-label {
            font-size: 0.9rem;
            color: #555;
            font-weight: 600;
        }

        .filter-input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .filter-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Health Records Table */
        .records-table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .records-table {
            width: 100%;
            border-collapse: collapse;
        }

        .records-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 18px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            position: relative;
        }

        .records-table th:hover {
            background: linear-gradient(135deg, #5a6fd8, #6a42a0);
        }

        .records-table th.sortable::after {
            content: ' ‚ÜïÔ∏è';
            position: absolute;
            right: 8px;
            font-size: 0.8rem;
        }

        .records-table td {
            padding: 15px 12px;
            border-bottom: 1px solid #dee2e6;
            vertical-align: middle;
            font-size: 0.9rem;
        }

        .records-table tbody tr:hover {
            background: #f8f9ff;
        }

        .records-table tbody tr:nth-child(even) {
            background: #fafbfc;
        }

        .records-table tbody tr:nth-child(even):hover {
            background: #f0f2ff;
        }

        /* Parameter Value Styling */
        .param-value {
            font-weight: 600;
            font-size: 1rem;
        }

        .param-name {
            font-weight: 600;
            color: #333;
        }

        .param-status {
            font-weight: 600;
        }

        .status-normal { color: #28a745; }
        .status-high { color: #dc3545; }
        .status-low { color: #ffc107; }

        /* Category Badges */
        .category-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .category-cardiovascular { background: #ffe8e8; color: #c82333; }
        .category-metabolic { background: #fff3cd; color: #856404; }
        .category-hormonal { background: #e8f4fd; color: #0c5460; }
        .category-nutritional { background: #d4edda; color: #155724; }
        .category-hematology { background: #fce4ec; color: #880e4f; }
        .category-general { background: #f5f5f5; color: #424242; }

        /* Analysis Results */
        .analysis-results {
            display: none;
            background: linear-gradient(135deg, #e8f5e8, #f0f8ff);
            border: 2px solid #28a745;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
        }

        .analysis-results.show {
            display: block;
        }

        .analysis-title {
            font-size: 1.5rem;
            color: #155724;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
        }

        .analysis-content {
            line-height: 1.7;
            color: #333;
            font-size: 1rem;
        }

        .analysis-section {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .analysis-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* File Upload Modal */
        .upload-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .upload-modal.show {
            display: flex;
        }

        .upload-modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #f0f2ff;
        }

        .upload-icon {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 10px;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .documents-header,
            .records-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .records-filters {
                grid-template-columns: 1fr;
            }
            
            .documents-table,
            .records-table {
                font-size: 0.8rem;
            }
            
            .documents-table th,
            .documents-table td,
            .records-table th,
            .records-table td {
                padding: 10px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü©∫ HealthAI</h1>
            <p>Privacy-First Health Document Analysis powered by Edge AI</p>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-button active" onclick="showTab('documents')">
                üìÑ Document History
            </button>
            <button class="tab-button" onclick="showTab('records')">
                üî¨ Health Records
            </button>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            
            <!-- Documents Tab -->
            <div class="tab-content active" id="documents-tab">
                <div class="documents-header">
                    <div class="documents-title">üìÑ Your Health Documents</div>
                    <button class="upload-btn" onclick="showUploadModal()">
                        <span>üì§</span> Upload New Document
                    </button>
                </div>

                <div class="documents-table-container">
                    <table class="documents-table">
                        <thead>
                            <tr>
                                <th>üìÖ Upload Date</th>
                                <th>üìã Document Name</th>
                                <th>üìä Parameters Found</th>
                                <th>üóìÔ∏è Test Date</th>
                                <th>‚ö° Status</th>
                                <th>üîß Actions</th>
                            </tr>
                        </thead>
                        <tbody id="documentsTableBody">
                            <tr>
                                <td colspan="6" class="loading">üìã Loading your documents...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Health Records Tab -->
            <div class="tab-content" id="records-tab">
                <div class="records-header">
                    <div class="records-title">üî¨ Health Parameters Analysis</div>
                    <button class="analyze-btn" onclick="performCrossParameterAnalysis()" id="analyzeButton">
                        <span>üß†</span> Analyze All Parameters
                    </button>
                </div>

                <!-- Filters -->
                <div class="records-filters">
                    <div class="filter-group">
                        <label class="filter-label">üîç Search Parameter:</label>
                        <input type="text" id="parameterSearch" class="filter-input" 
                               placeholder="Search by parameter name..." oninput="filterHealthRecords()">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">üìÖ From Date:</label>
                        <input type="date" id="dateFromFilter" class="filter-input" onchange="filterHealthRecords()">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">üìÖ To Date:</label>
                        <input type="date" id="dateToFilter" class="filter-input" onchange="filterHealthRecords()">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">üè∑Ô∏è Category:</label>
                        <select id="categoryFilter" class="filter-input" onchange="filterHealthRecords()">
                            <option value="">All Categories</option>
                            <option value="Cardiovascular">üíì Cardiovascular</option>
                            <option value="Metabolic">‚ö° Metabolic</option>
                            <option value="Hormonal">üß¨ Hormonal</option>
                            <option value="Nutritional">ü•ó Nutritional</option>
                            <option value="Hematology">ü©∏ Blood Work</option>
                            <option value="General">üìã General</option>
                        </select>
                    </div>
                </div>

                <!-- Health Records Table -->
                <div class="records-table-container">
                    <table class="records-table">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortRecords('test_date')">üìÖ Test Date</th>
                                <th class="sortable" onclick="sortRecords('parameter_name')">üî¨ Parameter</th>
                                <th class="sortable" onclick="sortRecords('parameter_value')">üìä Your Value</th>
                                <th>üìè Unit</th>
                                <th>üìã Normal Range</th>
                                <th class="sortable" onclick="sortRecords('status')">‚ö†Ô∏è Status</th>
                                <th>üè∑Ô∏è Category</th>
                                <th>üìÑ Source</th>
                            </tr>
                        </thead>
                        <tbody id="recordsTableBody">
                            <tr>
                                <td colspan="8" class="loading">üî¨ Loading health records...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Analysis Results -->
                <div class="analysis-results" id="analysisResults">
                    <div class="analysis-title">üß† Cross-Parameter Health Analysis</div>
                    <div class="analysis-content" id="analysisContent">
                        <!-- Analysis content will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload Modal -->
        <div class="upload-modal" id="uploadModal">
            <div class="upload-modal-content">
                <button class="close-modal" onclick="hideUploadModal()">√ó</button>
                <h3 style="text-align: center; margin-bottom: 20px; color: #333;">üì§ Upload Health Document</h3>
                
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üìÑ</div>
                    <div class="upload-text">Drop your PDF here or click to browse</div>
                    <div style="font-size: 0.9rem; color: #999; margin-top: 10px;">
                        Supported: PDF files up to 25MB
                    </div>
                </div>
                
                <input type="file" id="fileInput" accept=".pdf" style="display: none;">
                
                <div id="uploadProgress" style="display: none; margin-top: 20px;">
                    <div style="text-align: center; margin-bottom: 10px;">
                        <span class="spinner"></span>
                        <span id="progressText">Processing document...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="build-info">
        Build 1.0.8 | analysemyhealth.com
    </div>

    <script>
        // Global variables
        let allDocuments = [];
        let allHealthRecords = [];
        let filteredHealthRecords = [];
        let currentSort = { column: 'test_date', direction: 'desc' };

        // Initialize the application
        window.addEventListener('load', () => {
            showTab('documents');
            loadDocuments();
        });

        // Tab switching
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Hide all tab buttons active state
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Activate selected tab button
            event.target.classList.add('active');
            
            // Load appropriate data
            if (tabName === 'documents') {
                loadDocuments();
            } else if (tabName === 'records') {
                loadHealthRecords();
            }
        }

        // Load documents for the main tab
        function loadDocuments() {
            console.log('Loading documents...');
            
            const currentSession = getCurrentSession();
            if (!currentSession || !currentSession.session_token) {
                document.getElementById('documentsTableBody').innerHTML = `
                    <tr><td colspan="6" class="loading">‚ùå Please log in to view your documents</td></tr>
                `;
                return;
            }

            document.getElementById('documentsTableBody').innerHTML = `
                <tr><td colspan="6" class="loading">üìã Loading your documents...</td></tr>
            `;

            fetch('/api/documents?action=list&sessionToken=' + encodeURIComponent(currentSession.session_token))
                .then(response => response.json())
                .then(data => {
                    console.log('Documents loaded:', data);
                    
                    if (data.success) {
                        allDocuments = data.documents || [];
                        displayDocuments();
                    } else {
                        throw new Error(data.error || 'Failed to load documents');
                    }
                })
                .catch(error => {
                    console.error('Error loading documents:', error);
                    document.getElementById('documentsTableBody').innerHTML = `
                        <tr><td colspan="6" class="loading">‚ùå Error loading documents: ${error.message}</td></tr>
                    `;
                });
        }

        // Display documents in the table
        function displayDocuments() {
            const tbody = document.getElementById('documentsTableBody');
            
            if (allDocuments.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="6" class="loading">üìÑ No documents uploaded yet. Click "Upload New Document" to get started!</td></tr>
                `;
                return;
            }

            tbody.innerHTML = allDocuments.map(doc => `
                <tr>
                    <td>${formatDate(doc.created_at)}</td>
                    <td class="param-name">${doc.file_name}</td>
                    <td><strong>${doc.parameters_count || 0}</strong> parameters</td>
                    <td>${doc.test_date ? formatDate(doc.test_date) : 'Not detected'}</td>
                    <td><span class="status-badge status-processed">‚úÖ Processed</span></td>
                    <td>
                        <button class="action-btn view" onclick="viewDocument('${doc.document_id}')">üëÅÔ∏è View</button>
                        <button class="action-btn delete" onclick="deleteDocument('${doc.document_id}')">üóëÔ∏è Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        // Load health records for the records tab
        function loadHealthRecords() {
            console.log('Loading health records...');
            
            const currentSession = getCurrentSession();
            if (!currentSession || !currentSession.session_token) {
                document.getElementById('recordsTableBody').innerHTML = `
                    <tr><td colspan="8" class="loading">‚ùå Please log in to view your health records</td></tr>
                `;
                return;
            }

            document.getElementById('recordsTableBody').innerHTML = `
                <tr><td colspan="8" class="loading">üî¨ Loading health records...</td></tr>
            `;

            fetch('/api/documents?action=healthRecords&sessionToken=' + encodeURIComponent(currentSession.session_token))
                .then(response => response.json())
                .then(data => {
                    console.log('Health records loaded:', data);
                    
                    if (data.success) {
                        allHealthRecords = data.healthRecords || [];
                        filterHealthRecords();
                        
                        // Enable/disable analyze button
                        const analyzeBtn = document.getElementById('analyzeButton');
                        if (allHealthRecords.length > 0) {
                            analyzeBtn.disabled = false;
                            analyzeBtn.innerHTML = '<span>üß†</span> Analyze All Parameters';
                        } else {
                            analyzeBtn.disabled = true;
                            analyzeBtn.innerHTML = '<span>üß†</span> No Data to Analyze';
                        }
                    } else {
                        throw new Error(data.error || 'Failed to load health records');
                    }
                })
                .catch(error => {
                    console.error('Error loading health records:', error);
                    document.getElementById('recordsTableBody').innerHTML = `
                        <tr><td colspan="8" class="loading">‚ùå Error loading records: ${error.message}</td></tr>
                    `;
                });
        }

        // Filter health records
        function filterHealthRecords() {
            const searchTerm = document.getElementById('parameterSearch').value.toLowerCase();
            const dateFrom = document.getElementById('dateFromFilter').value;
            const dateTo = document.getElementById('dateToFilter').value;
            const category = document.getElementById('categoryFilter').value;
            
            filteredHealthRecords = allHealthRecords.filter(record => {
                if (searchTerm && !record.parameter_name.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                if (dateFrom && record.test_date < dateFrom) return false;
                if (dateTo && record.test_date > dateTo) return false;
                if (category && record.category !== category) return false;
                return true;
            });
            
            sortRecords(currentSort.column);
            displayHealthRecords();
        }

        // Sort health records
        function sortRecords(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            
            filteredHealthRecords.sort((a, b) => {
                let valueA = a[column];
                let valueB = b[column];
                
                if (column === 'test_date') {
                    valueA = new Date(valueA || '1900-01-01');
                    valueB = new Date(valueB || '1900-01-01');
                } else if (column === 'parameter_value') {
                    valueA = parseFloat(valueA) || 0;
                    valueB = parseFloat(valueB) || 0;
                } else {
                    valueA = (valueA || '').toString().toLowerCase();
                    valueB = (valueB || '').toString().toLowerCase();
                }
                
                if (valueA < valueB) return currentSort.direction === 'asc' ? -1 : 1;
                if (valueA > valueB) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });
            
            displayHealthRecords();
        }

        // Display health records in table
        function displayHealthRecords() {
            const tbody = document.getElementById('recordsTableBody');
            
            if (filteredHealthRecords.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="8" class="loading">üî¨ No health records match your filters. Upload some documents to get started!</td></tr>
                `;
                return;
            }

            tbody.innerHTML = filteredHealthRecords.map(record => `
                <tr>
                    <td>${formatDate(record.test_date)}</td>
                    <td class="param-name">${record.parameter_name}</td>
                    <td class="param-value">${record.parameter_value}</td>
                    <td>${record.parameter_unit || ''}</td>
                    <td>${record.reference_range || 'N/A'}</td>
                    <td class="param-status status-${record.status.toLowerCase()}">
                        ${getStatusIcon(record.status)} ${record.status}
                    </td>
                    <td>
                        <span class="category-badge category-${record.category.toLowerCase().replace(' ', '-')}">
                            ${getCategoryIcon(record.category)} ${record.category}
                        </span>
                    </td>
                    <td title="${record.file_name || 'Unknown'}">${truncateText(record.file_name || 'Unknown', 20)}</td>
                </tr>
            `).join('');
        }

        // Perform cross-parameter analysis
        async function performCrossParameterAnalysis() {
            console.log('Starting cross-parameter analysis...');
            
            const analyzeBtn = document.getElementById('analyzeButton');
            const analysisResults = document.getElementById('analysisResults');
            const analysisContent = document.getElementById('analysisContent');
            
            if (allHealthRecords.length === 0) {
                alert('No health records available for analysis. Please upload some documents first.');
                return;
            }

            // Show loading state
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<span class="spinner"></span> Analyzing...';
            analysisResults.classList.add('show');
            analysisContent.innerHTML = `
                <div class="analysis-section">
                    <div style="text-align: center; padding: 20px;">
                        <span class="spinner"></span>
                        <p>üß† Analyzing all your health parameters...</p>
                        <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">
                            This may take a few moments as we process historical data and consult medical databases.
                        </p>
                    </div>
                </div>
            `;

            try {
                // Step 1: Prepare comprehensive health data for analysis
                const healthDataSummary = prepareHealthDataForAnalysis();
                console.log('Health data prepared for analysis:', healthDataSummary);

                // Step 2: Get AI analysis with historical context
                const analysisResponse = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        healthData: healthDataSummary,
                        analysisType: 'comprehensive',
                        includeHistorical: true,
                        requestMedicalContext: true
                    })
                });

                if (!analysisResponse.ok) {
                    const errorData = await analysisResponse.json();
                    throw new Error(errorData.error || `Analysis failed: ${analysisResponse.status}`);
                }

                const analysisData = await analysisResponse.json();
                console.log('Cross-parameter analysis complete:', analysisData);

                // Step 3: Get additional medical context from MedlinePlus
                let medicalContext = null;
                try {
                    const contextResponse = await fetch('/api/medical-context', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            healthParameters: getUniqueParameters()
                        })
                    });

                    if (contextResponse.ok) {
                        medicalContext = await contextResponse.json();
                        console.log('Medical context retrieved:', medicalContext);
                    }
                } catch (error) {
                    console.warn('Medical context retrieval failed:', error);
                }

                // Step 4: Display comprehensive results
                displayComprehensiveAnalysis(analysisData, medicalContext);

            } catch (error) {
                console.error('Cross-parameter analysis failed:', error);
                analysisContent.innerHTML = `
                    <div class="analysis-section">
                        <h3 style="color: #dc3545;">‚ùå Analysis Failed</h3>
                        <p>We encountered an error while analyzing your health data:</p>
                        <p style="color: #dc3545; font-weight: 600;">${error.message}</p>
                        <p style="margin-top: 15px;">Please try again, or contact support if the problem persists.</p>
                    </div>
                `;
            } finally {
                // Reset button state
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = '<span>üß†</span> Analyze All Parameters';
            }
        }

        // Prepare health data for comprehensive analysis
        function prepareHealthDataForAnalysis() {
            const uniqueParams = {};
            const parameterHistory = {};
            
            // Group parameters by name and collect historical data
            allHealthRecords.forEach(record => {
                const paramName = record.parameter_name;
                
                if (!uniqueParams[paramName]) {
                    uniqueParams[paramName] = {
                        latest: record,
                        count: 0,
                        history: []
                    };
                    parameterHistory[paramName] = [];
                }
                
                uniqueParams[paramName].count++;
                parameterHistory[paramName].push({
                    value: record.parameter_value,
                    date: record.test_date,
                    status: record.status,
                    numeric_value: record.numeric_value
                });
                
                // Update latest if this record is more recent
                if (new Date(record.test_date) > new Date(uniqueParams[paramName].latest.test_date)) {
                    uniqueParams[paramName].latest = record;
                }
            });

            // Sort historical data by date
            Object.keys(parameterHistory).forEach(paramName => {
                parameterHistory[paramName].sort((a, b) => new Date(a.date) - new Date(b.date));
                uniqueParams[paramName].history = parameterHistory[paramName];
            });

            // Create comprehensive summary
            const totalRecords = allHealthRecords.length;
            const uniqueParametersCount = Object.keys(uniqueParams).length;
            const dateRange = getDateRange();
            const categorySummary = getCategorySummary();
            const riskIndicators = identifyRiskIndicators(uniqueParams);

            const summary = `
COMPREHENSIVE HEALTH DATA ANALYSIS REQUEST

Patient Health Overview:
- Total Health Records: ${totalRecords}
- Unique Parameters Tracked: ${uniqueParametersCount}
- Date Range: ${dateRange.earliest} to ${dateRange.latest}
- Time Span: ${dateRange.daysCovered} days of health data

Parameter Categories:
${Object.entries(categorySummary).map(([category, count]) => 
    `- ${category}: ${count} parameters`
).join('\n')}

Current Health Parameters with Historical Context:
${Object.entries(uniqueParams).map(([paramName, data]) => {
    const trend = calculateTrend(data.history);
    const latest = data.latest;
    return `
‚Ä¢ ${paramName}: ${latest.parameter_value} ${latest.parameter_unit || ''} (${latest.status})
  Reference: ${latest.reference_range || 'N/A'}
  Category: ${latest.category}
  Historical Records: ${data.count} measurements
  Trend: ${trend.direction} (${trend.description})
  Date Range: ${data.history[0]?.date} to ${latest.test_date}`;
}).join('\n')}

Risk Indicators Identified:
${riskIndicators.length > 0 ? riskIndicators.map(risk => `- ${risk}`).join('\n') : '- No significant risk indicators detected'}

ANALYSIS REQUEST:
Please provide a comprehensive cross-parameter health analysis including:
1. Overall health status assessment
2. Parameter correlations and interactions
3. Trend analysis and health trajectory
4. Risk factor identification
5. Personalized health recommendations
6. Areas requiring medical attention
7. Lifestyle modification suggestions

Focus on relationships between parameters, historical trends, and evidence-based health insights.
            `.trim();

            return summary;
        }

        // Calculate trend for parameter history
        function calculateTrend(history) {
            if (history.length < 2) {
                return { direction: 'stable', description: 'Insufficient data for trend analysis' };
            }

            const numericHistory = history
                .map(h => parseFloat(h.value))
                .filter(v => !isNaN(v));

            if (numericHistory.length < 2) {
                return { direction: 'stable', description: 'Non-numeric data' };
            }

            const first = numericHistory[0];
            const last = numericHistory[numericHistory.length - 1];
            const changePercent = ((last - first) / first) * 100;

            if (Math.abs(changePercent) < 5) {
                return { direction: 'stable', description: `${changePercent.toFixed(1)}% change` };
            } else if (changePercent > 0) {
                return { direction: 'increasing', description: `${changePercent.toFixed(1)}% increase` };
            } else {
                return { direction: 'decreasing', description: `${Math.abs(changePercent).toFixed(1)}% decrease` };
            }
        }

        // Get date range of all records
        function getDateRange() {
            const dates = allHealthRecords
                .map(r => new Date(r.test_date))
                .filter(d => !isNaN(d))
                .sort((a, b) => a - b);

            if (dates.length === 0) {
                return { earliest: 'N/A', latest: 'N/A', daysCovered: 0 };
            }

            const earliest = dates[0];
            const latest = dates[dates.length - 1];
            const daysCovered = Math.ceil((latest - earliest) / (1000 * 60 * 60 * 24));

            return {
                earliest: earliest.toISOString().split('T')[0],
                latest: latest.toISOString().split('T')[0],
                daysCovered: daysCovered
            };
        }

        // Get category summary
        function getCategorySummary() {
            const categories = {};
            allHealthRecords.forEach(record => {
                const category = record.category || 'General';
                categories[category] = (categories[category] || 0) + 1;
            });
            return categories;
        }

        // Identify risk indicators
        function identifyRiskIndicators(uniqueParams) {
            const risks = [];
            
            Object.entries(uniqueParams).forEach(([paramName, data]) => {
                const latest = data.latest;
                if (latest.status === 'High' || latest.status === 'Low') {
                    risks.push(`${paramName} is ${latest.status.toLowerCase()} (${latest.parameter_value})`);
                }
            });

            return risks;
        }

        // Get unique parameters for medical context
        function getUniqueParameters() {
            const unique = [];
            const seen = new Set();
            
            allHealthRecords.forEach(record => {
                if (!seen.has(record.parameter_name)) {
                    seen.add(record.parameter_name);
                    unique.push({
                        name: record.parameter_name,
                        category: record.category,
                        latest_value: record.parameter_value,
                        unit: record.parameter_unit
                    });
                }
            });

            return unique;
        }

        // Display comprehensive analysis results
        function displayComprehensiveAnalysis(analysisData, medicalContext) {
            const analysisContent = document.getElementById('analysisContent');
            
            let analysisText = '';
            if (analysisData.success && analysisData.analysis) {
                analysisText = analysisData.analysis;
            } else if (analysisData.response) {
                analysisText = analysisData.response;
            } else {
                analysisText = 'Analysis completed but no insights were generated.';
            }

            // Clean and format the analysis text
            let formattedAnalysis = analysisText
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n\n+/g, '\n\n')
                .replace(/\n/g, '<br>');

            // Split into sections if possible
            const sections = formattedAnalysis.split(/(?=\d+\.\s|\b(?:Overall|Parameter|Trend|Risk|Recommendation|Lifestyle|Medical)\b.*?:)/i);

            let sectionsHtml = '';
            sections.forEach((section, index) => {
                if (section.trim()) {
                    const title = section.match(/^(.*?):/);
                    const content = title ? section.replace(title[0], '').trim() : section.trim();
                    const sectionTitle = title ? title[1].trim() : `Analysis Section ${index + 1}`;
                    
                    sectionsHtml += `
                        <div class="analysis-section">
                            <h3>${sectionTitle}</h3>
                            <div>${content}</div>
                        </div>
                    `;
                }
            });

            // Add medical context if available
            let medicalContextHtml = '';
            if (medicalContext && medicalContext.context && medicalContext.context.length > 0) {
                medicalContextHtml = `
                    <div class="analysis-section">
                        <h3>üè• Medical Knowledge Base</h3>
                        <div>
                            ${medicalContext.context.map(item => `
                                <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                    <strong>${item.parameter}:</strong><br>
                                    ${item.info}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            analysisContent.innerHTML = `
                ${sectionsHtml || `
                    <div class="analysis-section">
                        <h3>üß† Health Analysis Results</h3>
                        <div>${formattedAnalysis}</div>
                    </div>
                `}
                ${medicalContextHtml}
                <div class="analysis-section">
                    <h3>üìä Analysis Summary</h3>
                    <div>
                        <p><strong>Records Analyzed:</strong> ${allHealthRecords.length} health parameters</p>
                        <p><strong>Unique Parameters:</strong> ${getUniqueParameters().length} different measurements</p>
                        <p><strong>Date Range:</strong> ${getDateRange().earliest} to ${getDateRange().latest}</p>
                        <p><strong>Analysis Date:</strong> ${new Date().toLocaleString()}</p>
                        <p style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px; color: #856404;">
                            <strong>‚ö†Ô∏è Important:</strong> This analysis is for informational purposes only. 
                            Always consult with healthcare professionals for medical decisions.
                        </p>
                    </div>
                </div>
            `;
        }

        // Upload modal functions
        function showUploadModal() {
            document.getElementById('uploadModal').classList.add('show');
            setupUploadArea();
        }

        function hideUploadModal() {
            document.getElementById('uploadModal').classList.remove('show');
            document.getElementById('uploadProgress').style.display = 'none';
            document.getElementById('fileInput').value = '';
        }

        function setupUploadArea() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0]);
                }
            });

            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    handleFileUpload(e.dataTransfer.files[0]);
                }
            });
        }

        // Handle file upload
        async function handleFileUpload(file) {
            console.log('Starting file upload:', file.name);

            // Validate file
            if (!file.type.includes('pdf') && !file.name.toLowerCase().includes('.pdf')) {
                alert('Please upload a PDF file');
                return;
            }

            if (file.size > 25 * 1024 * 1024) {
                alert('File size must be under 25MB');
                return;
            }

            // Show progress
            document.getElementById('uploadProgress').style.display = 'block';
            document.getElementById('progressText').textContent = 'Processing document...';

            try {
                // Same upload process as before
                const formData = new FormData();
                formData.append('pdfFile', file);

                const extractResponse = await fetch('/api/extract', {
                    method: 'POST',
                    body: formData
                });

                if (!extractResponse.ok) {
                    const errorData = await extractResponse.json();
                    throw new Error(errorData.error || `Extract failed: ${extractResponse.status}`);
                }

                const extractData = await extractResponse.json();
                console.log('Extraction complete:', extractData);

                if (!extractData.success) {
                    throw new Error(extractData.error || 'Failed to extract health data');
                }

                // Store the document
                const currentSession = getCurrentSession();
                if (currentSession && currentSession.session_token) {
                    await fetch('/api/documents', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'store',
                            sessionToken: currentSession.session_token,
                            fileName: file.name,
                            documentType: 'Health Report',
                            extractedData: extractData
                        })
                    });
                }

                // Success
                hideUploadModal();
                alert(`‚úÖ Document uploaded successfully!\nFound ${extractData.healthParameters?.length || 0} health parameters.`);
                
                // Refresh current tab
                if (document.getElementById('documents-tab').classList.contains('active')) {
                    loadDocuments();
                } else {
                    loadHealthRecords();
                }

            } catch (error) {
                console.error('Upload failed:', error);
                document.getElementById('progressText').textContent = `‚ùå Upload failed: ${error.message}`;
            }
        }

        // Utility functions
        function getCurrentSession() {
            try {
                return JSON.parse(localStorage.getItem('healthai_session') || '{}');
            } catch {
                return {};
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            try {
                return new Date(dateString).toLocaleDateString();
            } catch {
                return dateString;
            }
        }

        function getStatusIcon(status) {
            const icons = { 'Normal': '‚úÖ', 'High': '‚¨ÜÔ∏è', 'Low': '‚¨áÔ∏è' };
            return icons[status] || '‚ùì';
        }

        function getCategoryIcon(category) {
            const icons = {
                'Cardiovascular': 'üíì', 'Metabolic': '‚ö°', 'Hormonal': 'üß¨',
                'Nutritional': 'ü•ó', 'Hematology': 'ü©∏', 'General': 'üìã'
            };
            return icons[category] || 'üìä';
        }

        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        function viewDocument(documentId) {
            alert(`View document: ${documentId}`);
        }

        function deleteDocument(documentId) {
            if (confirm('Are you sure you want to delete this document?')) {
                console.log('Delete document:', documentId);
                // Implement delete functionality
            }
        }

        // Initialize session if needed (basic session management)
        if (!getCurrentSession().session_token) {
            const sessionToken = 'session_' + Date.now() + '_' + Math.random().toString(36).substring(2);
            localStorage.setItem('healthai_session', JSON.stringify({
                session_token: sessionToken,
                created_at: new Date().toISOString()
            }));
        }
    </script>
</body>
</html>
