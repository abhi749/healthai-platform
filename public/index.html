<!-- Enhanced Health Records Tab HTML Section -->
<div class="tab-content" id="records-tab">
    <div class="section-title">📋 Health Records Dashboard</div>
    
    <!-- Stats Dashboard -->
    <div class="stats-dashboard">
        <div class="stat-card">
            <div class="stat-number" id="totalRecordsCount">--</div>
            <div class="stat-label">Total Parameters</div>
            <div class="stat-icon">📊</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="uniqueParametersCount">--</div>
            <div class="stat-label">Unique Parameters</div>
            <div class="stat-icon">🔬</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="documentsCount">--</div>
            <div class="stat-label">Documents</div>
            <div class="stat-icon">📄</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="dateRangeDisplay">--</div>
            <div class="stat-label">Date Range</div>
            <div class="stat-icon">📅</div>
        </div>
    </div>

    <!-- Advanced Filters -->
    <div class="filters-section">
        <div class="filter-row">
            <div class="filter-group">
                <label>🔍 Search Parameters:</label>
                <input type="text" id="parameterSearch" placeholder="Search by parameter name..." 
                       class="filter-input" oninput="filterHealthRecords()">
            </div>
            <div class="filter-group">
                <label>📅 Date Range:</label>
                <input type="date" id="dateFromFilter" class="filter-input" onchange="filterHealthRecords()">
                <span>to</span>
                <input type="date" id="dateToFilter" class="filter-input" onchange="filterHealthRecords()">
            </div>
        </div>
        <div class="filter-row">
            <div class="filter-group">
                <label>🏷️ Category:</label>
                <select id="categoryFilter" class="filter-input" onchange="filterHealthRecords()">
                    <option value="">All Categories</option>
                    <option value="Cardiovascular">💓 Cardiovascular</option>
                    <option value="Metabolic">⚡ Metabolic</option>
                    <option value="Hormonal">🧬 Hormonal</option>
                    <option value="Nutritional">🥗 Nutritional</option>
                    <option value="Inflammatory">🔥 Inflammatory</option>
                    <option value="Hematology">🩸 Blood Work</option>
                    <option value="Liver Function">🫘 Liver Function</option>
                    <option value="Kidney Function">🫘 Kidney Function</option>
                    <option value="General">📋 General</option>
                </select>
            </div>
            <div class="filter-group">
                <label>⚠️ Status:</label>
                <select id="statusFilter" class="filter-input" onchange="filterHealthRecords()">
                    <option value="">All Status</option>
                    <option value="Normal">✅ Normal</option>
                    <option value="High">⬆️ High</option>
                    <option value="Low">⬇️ Low</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Actions:</label>
                <button class="btn" onclick="loadHealthRecords()">🔄 Refresh</button>
                <button class="btn btn-secondary" onclick="exportHealthRecords()">📋 Export CSV</button>
                <button class="btn btn-secondary" onclick="clearFilters()">🗑️ Clear Filters</button>
            </div>
        </div>
    </div>

    <!-- Excel-like Table -->
    <div class="excel-table-container">
        <div class="table-header">
            <div class="table-title">📊 Detailed Health Parameters</div>
            <div class="table-meta">
                <span id="filteredResultsCount">0</span> results 
                <span id="filterStatus"></span>
            </div>
        </div>
        
        <div class="table-wrapper">
            <table class="excel-table" id="healthRecordsTable">
                <thead>
                    <tr>
                        <th class="sortable" onclick="sortTable('test_date')">
                            📅 Test Date 
                            <span class="sort-indicator" id="sort-test_date"></span>
                        </th>
                        <th class="sortable" onclick="sortTable('parameter_name')">
                            🔬 Parameter 
                            <span class="sort-indicator" id="sort-parameter_name"></span>
                        </th>
                        <th class="sortable" onclick="sortTable('parameter_value')">
                            📊 Value 
                            <span class="sort-indicator" id="sort-parameter_value"></span>
                        </th>
                        <th>📏 Unit</th>
                        <th>📋 Reference Range</th>
                        <th class="sortable" onclick="sortTable('status')">
                            ⚠️ Status 
                            <span class="sort-indicator" id="sort-status"></span>
                        </th>
                        <th class="sortable" onclick="sortTable('category')">
                            🏷️ Category 
                            <span class="sort-indicator" id="sort-category"></span>
                        </th>
                        <th>📄 Document</th>
                        <th>📈 Trend</th>
                    </tr>
                </thead>
                <tbody id="healthRecordsTableBody">
                    <tr>
                        <td colspan="9" class="loading">📋 Loading health records...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Parameter Summary Cards -->
    <div class="parameter-summary" id="parameterSummary">
        <div class="summary-title">📊 Parameter Summary</div>
        <div class="summary-cards" id="parameterCards">
            <!-- Parameter cards will be populated here -->
        </div>
    </div>
</div>

<style>
/* Enhanced Health Records Styling */
.stats-dashboard {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 15px;
    text-align: center;
    position: relative;
    overflow: hidden;
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-number {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 5px;
}

.stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

.stat-icon {
    position: absolute;
    top: 20px;
    right: 20px;
    font-size: 1.5rem;
    opacity: 0.3;
}

.filters-section {
    background: white;
    padding: 25px;
    border-radius: 15px;
    margin-bottom: 25px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.filter-row {
    display: flex;
    gap: 20px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}

.filter-row:last-child {
    margin-bottom: 0;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
    flex: 1;
    min-width: 200px;
}

.filter-group label {
    font-size: 0.9rem;
    color: #555;
    font-weight: 600;
}

.filter-input {
    padding: 10px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 0.9rem;
    transition: border-color 0.3s ease;
}

.filter-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.excel-table-container {
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    overflow: hidden;
    margin-bottom: 30px;
}

.table-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px 25px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.table-title {
    font-size: 1.3rem;
    font-weight: 600;
}

.table-meta {
    font-size: 0.9rem;
    opacity: 0.9;
}

.table-wrapper {
    overflow-x: auto;
    max-height: 600px;
    overflow-y: auto;
}

.excel-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
}

.excel-table th {
    background: #f8f9fa;
    color: #333;
    font-weight: 600;
    padding: 15px 12px;
    text-align: left;
    border-bottom: 2px solid #e9ecef;
    position: sticky;
    top: 0;
    z-index: 10;
    white-space: nowrap;
}

.excel-table th.sortable {
    cursor: pointer;
    transition: background-color 0.2s ease;
    user-select: none;
}

.excel-table th.sortable:hover {
    background: #e9ecef;
}

.sort-indicator {
    margin-left: 5px;
    font-size: 0.8rem;
    color: #667eea;
}

.excel-table td {
    padding: 12px;
    border-bottom: 1px solid #e9ecef;
    vertical-align: middle;
    transition: background-color 0.2s ease;
}

.excel-table tbody tr:hover {
    background: #f8f9ff;
}

.excel-table tbody tr:nth-child(even) {
    background: #fafbfc;
}

.excel-table tbody tr:nth-child(even):hover {
    background: #f0f2ff;
}

/* Status styling */
.status-normal { color: #28a745; font-weight: 600; }
.status-high { color: #dc3545; font-weight: 600; }
.status-low { color: #ffc107; font-weight: 600; }

/* Category styling */
.category-cardiovascular { background: #ffe8e8; color: #c82333; }
.category-metabolic { background: #fff3cd; color: #856404; }
.category-hormonal { background: #e8f4fd; color: #0c5460; }
.category-nutritional { background: #d4edda; color: #155724; }
.category-inflammatory { background: #f8d7da; color: #721c24; }
.category-hematology { background: #fce4ec; color: #880e4f; }
.category-liver { background: #e1f5fe; color: #01579b; }
.category-kidney { background: #f3e5f5; color: #4a148c; }
.category-general { background: #f5f5f5; color: #424242; }

.category-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 500;
}

.trend-indicator {
    font-size: 1.2rem;
    cursor: pointer;
    transition: transform 0.2s ease;
}

.trend-indicator:hover {
    transform: scale(1.2);
}

.trend-up { color: #dc3545; }
.trend-down { color: #28a745; }
.trend-stable { color: #6c757d; }

.parameter-summary {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.summary-title {
    font-size: 1.3rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 20px;
    text-align: center;
}

.summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
}

.parameter-card {
    background: linear-gradient(135deg, #f8f9ff 0%, #e8f2ff 100%);
    border: 1px solid #e0e6ff;
    border-radius: 12px;
    padding: 20px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.parameter-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
}

.parameter-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.parameter-name {
    font-weight: 600;
    color: #333;
    font-size: 1.1rem;
}

.parameter-count {
    background: #667eea;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
}

.parameter-latest {
    font-size: 1.2rem;
    font-weight: 700;
    color: #667eea;
    margin-bottom: 5px;
}

.parameter-date {
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 10px;
}

.parameter-trend {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.9rem;
}

.loading {
    text-align: center;
    padding: 40px;
    color: #666;
    font-style: italic;
}

.btn {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 600;
    transition: transform 0.2s ease;
}

.btn:hover {
    transform: translateY(-2px);
}

.btn-secondary {
    background: linear-gradient(135deg, #6c757d, #5a6268);
}

/* Responsive design */
@media (max-width: 768px) {
    .stats-dashboard {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .filter-row {
        flex-direction: column;
    }
    
    .filter-group {
        min-width: auto;
    }
    
    .table-header {
        flex-direction: column;
        gap: 10px;
        text-align: center;
    }
    
    .excel-table {
        font-size: 0.8rem;
    }
    
    .excel-table th,
    .excel-table td {
        padding: 8px 6px;
    }
    
    .summary-cards {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
// Global variables for health records
let allHealthRecords = [];
let filteredHealthRecords = [];
let parameterStats = [];
let currentSort = { column: 'test_date', direction: 'desc' };

// Load health records when tab is activated
function loadHealthRecords() {
    console.log('Loading enhanced health records...');
    
    const currentSession = getCurrentSession();
    if (!currentSession || !currentSession.session_token) {
        document.getElementById('healthRecordsTableBody').innerHTML = `
            <tr><td colspan="9" class="loading">❌ Please log in to view your health records</td></tr>
        `;
        return;
    }

    // Show loading state
    document.getElementById('healthRecordsTableBody').innerHTML = `
        <tr><td colspan="9" class="loading">📋 Loading health records...</td></tr>
    `;

    // Fetch enhanced health records
    fetch('/api/documents?action=healthRecords&sessionToken=' + encodeURIComponent(currentSession.session_token))
        .then(response => response.json())
        .then(data => {
            console.log('Enhanced health records loaded:', data);
            
            if (data.success) {
                allHealthRecords = data.healthRecords || [];
                parameterStats = data.parameterStats || [];
                
                console.log(`Loaded ${allHealthRecords.length} health records`);
                console.log(`Found ${parameterStats.length} unique parameters`);
                
                // Update stats dashboard
                updateStatsDashboard(data);
                
                // Apply current filters and display
                filterHealthRecords();
                
                // Update parameter summary
                updateParameterSummary();
                
            } else {
                throw new Error(data.error || 'Failed to load health records');
            }
        })
        .catch(error => {
            console.error('Error loading health records:', error);
            document.getElementById('healthRecordsTableBody').innerHTML = `
                <tr><td colspan="9" class="loading">❌ Error loading records: ${error.message}</td></tr>
            `;
        });
}

// Update stats dashboard
function updateStatsDashboard(data) {
    document.getElementById('totalRecordsCount').textContent = data.totalRecords || 0;
    document.getElementById('uniqueParametersCount').textContent = data.uniqueParameters || 0;
    document.getElementById('documentsCount').textContent = data.documentsCount || 0;
    
    // Calculate date range
    if (data.healthRecords && data.healthRecords.length > 0) {
        const dates = data.healthRecords
            .map(r => r.test_date)
            .filter(d => d)
            .sort();
        
        if (dates.length > 0) {
            const earliest = new Date(dates[0]).toLocaleDateString();
            const latest = new Date(dates[dates.length - 1]).toLocaleDateString();
            document.getElementById('dateRangeDisplay').textContent = 
                dates.length > 1 ? `${earliest} - ${latest}` : earliest;
        } else {
            document.getElementById('dateRangeDisplay').textContent = 'No dates';
        }
    } else {
        document.getElementById('dateRangeDisplay').textContent = 'No data';
    }
}

// Filter health records based on current filter settings
function filterHealthRecords() {
    const searchTerm = document.getElementById('parameterSearch').value.toLowerCase();
    const dateFrom = document.getElementById('dateFromFilter').value;
    const dateTo = document.getElementById('dateToFilter').value;
    const category = document.getElementById('categoryFilter').value;
    const status = document.getElementById('statusFilter').value;
    
    filteredHealthRecords = allHealthRecords.filter(record => {
        // Search filter
        if (searchTerm && !record.parameter_name.toLowerCase().includes(searchTerm)) {
            return false;
        }
        
        // Date range filter
        if (dateFrom && record.test_date < dateFrom) return false;
        if (dateTo && record.test_date > dateTo) return false;
        
        // Category filter
        if (category && record.category !== category) return false;
        
        // Status filter
        if (status && record.status !== status) return false;
        
        return true;
    });
    
    // Apply current sort
    sortRecords();
    
    // Update display
    displayHealthRecords();
    updateFilterStatus();
}

// Sort records based on current sort settings
function sortRecords() {
    filteredHealthRecords.sort((a, b) => {
        let valueA = a[currentSort.column];
        let valueB = b[currentSort.column];
        
        // Handle different data types
        if (currentSort.column === 'test_date') {
            valueA = new Date(valueA || '1900-01-01');
            valueB = new Date(valueB || '1900-01-01');
        } else if (currentSort.column === 'parameter_value') {
            valueA = parseFloat(valueA) || 0;
            valueB = parseFloat(valueB) || 0;
        } else {
            valueA = (valueA || '').toString().toLowerCase();
            valueB = (valueB || '').toString().toLowerCase();
        }
        
        if (valueA < valueB) return currentSort.direction === 'asc' ? -1 : 1;
        if (valueA > valueB) return currentSort.direction === 'asc' ? 1 : -1;
        return 0;
    });
}

// Sort table by column
function sortTable(column) {
    if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.column = column;
        currentSort.direction = 'asc';
    }
    
    // Update sort indicators
    document.querySelectorAll('.sort-indicator').forEach(indicator => {
        indicator.textContent = '';
    });
    
    const indicator = document.getElementById(`sort-${column}`);
    if (indicator) {
        indicator.textContent = currentSort.direction === 'asc' ? '↑' : '↓';
    }
    
    filterHealthRecords();
}

// Display health records in table
function displayHealthRecords() {
    const tbody = document.getElementById('healthRecordsTableBody');
    
    if (filteredHealthRecords.length === 0) {
        tbody.innerHTML = `
            <tr><td colspan="9" class="loading">📋 No health records match your current filters</td></tr>
        `;
        return;
    }
    
    tbody.innerHTML = filteredHealthRecords.map(record => `
        <tr>
            <td>${formatDate(record.test_date)}</td>
            <td><strong>${record.parameter_name}</strong></td>
            <td><strong>${record.parameter_value}</strong></td>
            <td>${record.parameter_unit || ''}</td>
            <td>${record.reference_range || 'N/A'}</td>
            <td><span class="status-${record.status.toLowerCase()}">${getStatusIcon(record.status)} ${record.status}</span></td>
            <td><span class="category-badge category-${record.category.toLowerCase().replace(' ', '-')}">${getCategoryIcon(record.category)} ${record.category}</span></td>
            <td title="${record.file_name || 'Unknown'}">${truncateText(record.file_name || 'Unknown', 15)}</td>
            <td>${getTrendIndicator(record.parameter_name)}</td>
        </tr>
    `).join('');
}

// Update parameter summary cards
function updateParameterSummary() {
    const summaryContainer = document.getElementById('parameterCards');
    
    if (parameterStats.length === 0) {
        summaryContainer.innerHTML = '<div class="loading">📊 No parameter summaries available</div>';
        return;
    }
    
    summaryContainer.innerHTML = parameterStats.map(param => `
        <div class="parameter-card">
            <div class="parameter-card-header">
                <div class="parameter-name">${param.parameter_name}</div>
                <div class="parameter-count">${param.total_records}</div>
            </div>
            <div class="parameter-latest">${param.latest_value}</div>
            <div class="parameter-date">Latest: ${formatDate(param.latest_date)}</div>
            <div class="parameter-trend">
                <span class="trend-indicator trend-${param.trend}">${getTrendIcon(param.trend)}</span>
                <span>${param.trend.charAt(0).toUpperCase() + param.trend.slice(1)}</span>
            </div>
        </div>
    `).join('');
}

// Update filter status display
function updateFilterStatus() {
    const filteredCount = document.getElementById('filteredResultsCount');
    const filterStatus = document.getElementById('filterStatus');
    
    filteredCount.textContent = filteredHealthRecords.length;
    
    const activeFilters = [];
    if (document.getElementById('parameterSearch').value) activeFilters.push('search');
    if (document.getElementById('dateFromFilter').value || document.getElementById('dateToFilter').value) activeFilters.push('date');
    if (document.getElementById('categoryFilter').value) activeFilters.push('category');
    if (document.getElementById('statusFilter').value) activeFilters.push('status');
    
    if (activeFilters.length > 0) {
        filterStatus.textContent = `(${activeFilters.length} filter${activeFilters.length > 1 ? 's' : ''} active)`;
    } else {
        filterStatus.textContent = '';
    }
}

// Clear all filters
function clearFilters() {
    document.getElementById('parameterSearch').value = '';
    document.getElementById('dateFromFilter').value = '';
    document.getElementById('dateToFilter').value = '';
    document.getElementById('categoryFilter').value = '';
    document.getElementById('statusFilter').value = '';
    
    filterHealthRecords();
}

// Export health records to CSV
function exportHealthRecords() {
    if (filteredHealthRecords.length === 0) {
        alert('No data to export. Please load some health records first.');
        return;
    }
    
    const headers = ['Test Date', 'Parameter', 'Value', 'Unit', 'Reference Range', 'Status', 'Category', 'Document'];
    const csvContent = [
        headers.join(','),
        ...filteredHealthRecords.map(record => [
            record.test_date || '',
            record.parameter_name || '',
            record.parameter_value || '',
            record.parameter_unit || '',
            record.reference_range || '',
            record.status || '',
            record.category || '',
            record.file_name || ''
        ].map(field => `"${field}"`).join(','))
    ].join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `health-records-${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Utility functions
function formatDate(dateString) {
    if (!dateString) return 'Unknown';
    try {
        return new Date(dateString).toLocaleDateString();
    } catch {
        return dateString;
    }
}

function getStatusIcon(status) {
    const icons = {
        'Normal': '✅',
        'High': '⬆️',
        'Low': '⬇️'
    };
    return icons[status] || '❓';
}

function getCategoryIcon(category) {
    const icons = {
        'Cardiovascular': '💓',
        'Metabolic': '⚡',
        'Hormonal': '🧬',
        'Nutritional': '🥗',
        'Inflammatory': '🔥',
        'Hematology': '🩸',
        'Liver Function': '🫘',
        'Kidney Function': '🫘',
        'General': '📋'
    };
    return icons[category] || '📊';
}

function getTrendIcon(trend) {
    const icons = {
        'increasing': '📈',
        'decreasing': '📉',
        'stable': '➡️'
    };
    return icons[trend] || '📊';
}

function getTrendIndicator(parameterName) {
    const param = parameterStats.find(p => p.parameter_name === parameterName);
    if (!param) return '➡️';
    
    return `<span class="trend-indicator trend-${param.trend}" title="${param.trend}">${getTrendIcon(param.trend)}</span>`;
}

function truncateText(text, maxLength) {
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength) + '...';
}

// Initialize when tab is activated
function showTab(tabName) {
    // ... existing tab switching code ...
    
    if (tabName === 'records') {
        loadHealthRecords();
    }
}
</script>
