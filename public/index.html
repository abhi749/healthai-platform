<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthAI - Privacy-First Health Analysis</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/recharts@2.8.0/umd/Recharts.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
        }
        .upload-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .processing-animation {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, BarChart, Bar, PieChart, Pie, Cell } = Recharts;
        const { 
            Upload, FileText, Brain, Shield, Clock, Users, 
            TrendingUp, AlertTriangle, CheckCircle, X, 
            ArrowUpRight, ArrowDownRight, Activity,
            Heart, Droplets, Zap, Eye
        } = lucideReact;

        const HealthAIDashboard = () => {
            const [activeTab, setActiveTab] = useState('upload');
            const [healthData, setHealthData] = useState([]);
            const [isProcessing, setIsProcessing] = useState(false);
            const [processingProgress, setProcessingProgress] = useState(0);
            const [dragOver, setDragOver] = useState(false);
            const [analysisResults, setAnalysisResults] = useState(null);

            // Load data from localStorage on component mount
            useEffect(() => {
                const savedData = localStorage.getItem('healthAI_data');
                if (savedData) {
                    try {
                        setHealthData(JSON.parse(savedData));
                    } catch (error) {
                        console.error('Error loading saved data:', error);
                    }
                }
            }, []);

            // Save data to localStorage whenever healthData changes
            useEffect(() => {
                if (healthData.length > 0) {
                    localStorage.setItem('healthAI_data', JSON.stringify(healthData));
                }
            }, [healthData]);

            const simulateProcessing = useCallback(() => {
                setProcessingProgress(0);
                const interval = setInterval(() => {
                    setProcessingProgress(prev => {
                        if (prev >= 100) {
                            clearInterval(interval);
                            return 100;
                        }
                        return prev + 10;
                    });
                }, 200);
            }, []);

            const parseHealthDocument = (text, fileName) => {
                const metrics = {};
                const insights = [];
                const recommendations = [];

                // Enhanced parsing for various health metrics
                const patterns = {
                    'Total Cholesterol': /(?:total\s*)?cholesterol[\s:]*(\d+(?:\.\d+)?)/i,
                    'LDL Cholesterol': /ldl[\s\-]*cholesterol[\s:]*(\d+(?:\.\d+)?)/i,
                    'HDL Cholesterol': /hdl[\s\-]*cholesterol[\s:]*(\d+(?:\.\d+)?)/i,
                    'Triglycerides': /triglycerides?[\s:]*(\d+(?:\.\d+)?)/i,
                    'Glucose': /(?:fasting\s*)?glucose[\s:]*(\d+(?:\.\d+)?)/i,
                    'HbA1c': /hba1c[\s:]*(\d+(?:\.\d+)?)/i,
                    'Blood Pressure Systolic': /blood\s*pressure[\s:]*(\d+)/i,
                    'Blood Pressure Diastolic': /blood\s*pressure[\s:]*\d+\/(\d+)/i,
                    'Heart Rate': /heart\s*rate[\s:]*(\d+)/i,
                    'BMI': /bmi[\s:]*(\d+(?:\.\d+)?)/i,
                    'Weight': /weight[\s:]*(\d+(?:\.\d+)?)/i,
                    'Height': /height[\s:]*(\d+(?:\.\d+)?)/i,
                    'Hemoglobin': /(?:hb|hemoglobin)[\s:]*(\d+(?:\.\d+)?)/i,
                    'White Blood Cells': /(?:wbc|white\s*blood\s*cells?)[\s:]*(\d+(?:\.\d+)?)/i,
                    'Red Blood Cells': /(?:rbc|red\s*blood\s*cells?)[\s:]*(\d+(?:\.\d+)?)/i,
                    'Platelets': /platelets?[\s:]*(\d+(?:\.\d+)?)/i,
                    'Creatinine': /creatinine[\s:]*(\d+(?:\.\d+)?)/i,
                    'Blood Urea Nitrogen': /(?:bun|blood\s*urea\s*nitrogen)[\s:]*(\d+(?:\.\d+)?)/i,
                    'ALT': /alt[\s:]*(\d+(?:\.\d+)?)/i,
                    'AST': /ast[\s:]*(\d+(?:\.\d+)?)/i,
                    'Vitamin D': /vitamin\s*d[\s:]*(\d+(?:\.\d+)?)/i,
                    'Vitamin B12': /vitamin\s*b12[\s:]*(\d+(?:\.\d+)?)/i,
                    'TSH': /tsh[\s:]*(\d+(?:\.\d+)?)/i,
                    'T3': /t3[\s:]*(\d+(?:\.\d+)?)/i,
                    'T4': /t4[\s:]*(\d+(?:\.\d+)?)/i
                };

                Object.entries(patterns).forEach(([metric, pattern]) => {
                    const match = text.match(pattern);
                    if (match) {
                        const value = parseFloat(match[1]);
                        metrics[metric] = {
                            value: value,
                            unit: getUnit(metric),
                            normal_range: getNormalRange(metric)
                        };
                    }
                });

                // Generate AI insights based on detected metrics
                Object.entries(metrics).forEach(([metric, data]) => {
                    const assessment = assessMetric(metric, data.value);
                    if (assessment) {
                        insights.push(assessment.insight);
                        if (assessment.recommendation) {
                            recommendations.push(assessment.recommendation);
                        }
                    }
                });

                // Add general insights if we have multiple metrics
                if (Object.keys(metrics).length >= 3) {
                    insights.push("✨ Comprehensive health profile detected. Multiple biomarkers analyzed for complete assessment.");
                }

                if (Object.keys(metrics).length === 0) {
                    insights.push("📄 Document processed successfully. Consider uploading lab reports with numerical health values for detailed analysis.");
                }

                return {
                    fileName,
                    uploadDate: new Date().toISOString(),
                    metrics,
                    insights,
                    recommendations,
                    rawText: text.substring(0, 500) + (text.length > 500 ? '...' : ''),
                    processingTime: Math.random() * 2 + 1 // Simulate processing time
                };
            };

            const getUnit = (metric) => {
                const units = {
                    'Total Cholesterol': 'mg/dL',
                    'LDL Cholesterol': 'mg/dL',
                    'HDL Cholesterol': 'mg/dL',
                    'Triglycerides': 'mg/dL',
                    'Glucose': 'mg/dL',
                    'HbA1c': '%',
                    'Blood Pressure Systolic': 'mmHg',
                    'Blood Pressure Diastolic': 'mmHg',
                    'Heart Rate': 'bpm',
                    'BMI': 'kg/m²',
                    'Weight': 'kg',
                    'Height': 'cm',
                    'Hemoglobin': 'g/dL',
                    'White Blood Cells': '10³/µL',
                    'Red Blood Cells': '10⁶/µL',
                    'Platelets': '10³/µL',
                    'Creatinine': 'mg/dL',
                    'Blood Urea Nitrogen': 'mg/dL',
                    'ALT': 'U/L',
                    'AST': 'U/L',
                    'Vitamin D': 'ng/mL',
                    'Vitamin B12': 'pg/mL',
                    'TSH': 'mIU/L',
                    'T3': 'ng/dL',
                    'T4': 'µg/dL'
                };
                return units[metric] || '';
            };

            const getNormalRange = (metric) => {
                const ranges = {
                    'Total Cholesterol': '< 200 mg/dL',
                    'LDL Cholesterol': '< 100 mg/dL',
                    'HDL Cholesterol': '> 40 mg/dL (men), > 50 mg/dL (women)',
                    'Triglycerides': '< 150 mg/dL',
                    'Glucose': '70-99 mg/dL (fasting)',
                    'HbA1c': '< 5.7%',
                    'Blood Pressure Systolic': '< 120 mmHg',
                    'Blood Pressure Diastolic': '< 80 mmHg',
                    'Heart Rate': '60-100 bpm',
                    'BMI': '18.5-24.9 kg/m²',
                    'Hemoglobin': '12-16 g/dL (women), 14-18 g/dL (men)',
                    'White Blood Cells': '4.5-11.0 10³/µL',
                    'Red Blood Cells': '4.0-5.5 10⁶/µL',
                    'Platelets': '150-450 10³/µL',
                    'Creatinine': '0.6-1.2 mg/dL',
                    'Blood Urea Nitrogen': '7-20 mg/dL',
                    'ALT': '7-56 U/L',
                    'AST': '10-40 U/L',
                    'Vitamin D': '30-100 ng/mL',
                    'Vitamin B12': '200-900 pg/mL',
                    'TSH': '0.4-4.0 mIU/L',
                    'T3': '80-200 ng/dL',
                    'T4': '4.5-12.0 µg/dL'
                };
                return ranges[metric] || 'Consult reference ranges';
            };

            const assessMetric = (metric, value) => {
                const assessments = {
                    'Total Cholesterol': (val) => {
                        if (val < 200) return { insight: '✅ Total cholesterol is in optimal range', recommendation: null };
                        if (val < 240) return { insight: '⚠️ Total cholesterol is borderline high', recommendation: 'Consider dietary changes and regular exercise' };
                        return { insight: '🚨 Total cholesterol is high', recommendation: 'Consult healthcare provider for management plan' };
                    },
                    'LDL Cholesterol': (val) => {
                        if (val < 100) return { insight: '✅ LDL cholesterol is optimal', recommendation: null };
                        if (val < 130) return { insight: '⚠️ LDL cholesterol is near optimal', recommendation: 'Maintain healthy lifestyle habits' };
                        return { insight: '🚨 LDL cholesterol is elevated', recommendation: 'Focus on heart-healthy diet and regular exercise' };
                    },
                    'HDL Cholesterol': (val) => {
                        if (val >= 60) return { insight: '✅ HDL cholesterol is protective level', recommendation: null };
                        if (val >= 40) return { insight: '⚠️ HDL cholesterol is acceptable', recommendation: 'Consider increasing physical activity' };
                        return { insight: '🚨 HDL cholesterol is low', recommendation: 'Increase physical activity and consider omega-3 supplements' };
                    },
                    'Triglycerides': (val) => {
                        if (val < 150) return { insight: '✅ Triglycerides are in normal range', recommendation: null };
                        if (val < 200) return { insight: '⚠️ Triglycerides are borderline high', recommendation: 'Reduce simple carbohydrates and increase fiber' };
                        return { insight: '🚨 Triglycerides are elevated', recommendation: 'Significant dietary changes and weight management needed' };
                    },
                    'Glucose': (val) => {
                        if (val < 100) return { insight: '✅ Blood glucose is normal', recommendation: null };
                        if (val < 126) return { insight: '⚠️ Blood glucose indicates prediabetes', recommendation: 'Lifestyle modifications to prevent diabetes' };
                        return { insight: '🚨 Blood glucose indicates diabetes range', recommendation: 'Immediate medical consultation recommended' };
                    },
                    'HbA1c': (val) => {
                        if (val < 5.7) return { insight: '✅ HbA1c is in normal range', recommendation: null };
                        if (val < 6.5) return { insight: '⚠️ HbA1c indicates prediabetes', recommendation: 'Blood sugar management and lifestyle changes needed' };
                        return { insight: '🚨 HbA1c indicates diabetes', recommendation: 'Medical management and regular monitoring required' };
                    }
                };

                const assessor = assessments[metric];
                return assessor ? assessor(value) : null;
            };

            // Risk assessment functions
            const assessTriglyceridesRisk = (value) => {
                if (value < 150) return { level: 'Normal', color: 'text-green-600', description: 'Optimal triglyceride level' };
                if (value < 200) return { level: 'Borderline High', color: 'text-yellow-600', description: 'Slightly elevated, monitor diet' };
                if (value < 500) return { level: 'High', color: 'text-orange-600', description: 'High risk, lifestyle changes needed' };
                return { level: 'Very High', color: 'text-red-600', description: 'Very high risk, medical attention required' };
            };

            const assessGlucoseRisk = (value) => {
                if (value < 100) return { level: 'Normal', color: 'text-green-600', description: 'Optimal glucose level' };
                if (value < 126) return { level: 'Prediabetes', color: 'text-yellow-600', description: 'Elevated, lifestyle changes recommended' };
                return { level: 'Diabetes Range', color: 'text-red-600', description: 'High risk, consult healthcare provider' };
            };

            const assessHbA1cRisk = (value) => {
                if (value < 5.7) return { level: 'Normal', color: 'text-green-600', description: 'Optimal HbA1c level' };
                if (value < 6.5) return { level: 'Prediabetes', color: 'text-yellow-600', description: 'Elevated, monitor closely' };
                return { level: 'Diabetes Range', color: 'text-red-600', description: 'High risk, medical management needed' };
            };

            const handleFileUpload = async (files) => {
                if (files.length === 0) return;

                setIsProcessing(true);
                simulateProcessing();

                try {
                    const newHealthData = [];

                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        
                        // Simulate file reading and processing
                        const text = await new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                // Simulate health document content
                                const simulatedContent = `
                                    Health Report - ${file.name}
                                    Patient: [REDACTED FOR PRIVACY]
                                    Date: ${new Date().toLocaleDateString()}
                                    
                                    Lab Results:
                                    Total Cholesterol: ${Math.floor(Math.random() * 100) + 180} mg/dL
                                    LDL Cholesterol: ${Math.floor(Math.random() * 60) + 70} mg/dL
                                    HDL Cholesterol: ${Math.floor(Math.random() * 40) + 35} mg/dL
                                    Triglycerides: ${Math.floor(Math.random() * 150) + 100} mg/dL
                                    Glucose: ${Math.floor(Math.random() * 40) + 80} mg/dL
                                    HbA1c: ${(Math.random() * 2 + 4.5).toFixed(1)} %
                                    Blood Pressure: ${Math.floor(Math.random() * 40) + 110}/${Math.floor(Math.random() * 20) + 70} mmHg
                                    Heart Rate: ${Math.floor(Math.random() * 40) + 60} bpm
                                    BMI: ${(Math.random() * 10 + 20).toFixed(1)} kg/m²
                                    
                                    Additional Markers:
                                    Hemoglobin: ${(Math.random() * 4 + 12).toFixed(1)} g/dL
                                    White Blood Cells: ${(Math.random() * 6 + 4).toFixed(1)} 10³/µL
                                    Platelets: ${Math.floor(Math.random() * 300) + 150} 10³/µL
                                    Vitamin D: ${Math.floor(Math.random() * 50) + 20} ng/mL
                                    TSH: ${(Math.random() * 3 + 1).toFixed(2)} mIU/L
                                `;
                                resolve(simulatedContent);
                            };
                            reader.readAsText(file);
                        });

                        const analysisResult = parseHealthDocument(text, file.name);
                        newHealthData.push(analysisResult);
                    }

                    // Add the new documents to existing data
                    setHealthData(prevData => [...prevData, ...newHealthData]);

                    // Set the latest analysis result for display
                    if (newHealthData.length > 0) {
                        setAnalysisResults(newHealthData[newHealthData.length - 1]);
                        setActiveTab('results');
                    }

                    console.log('Multi-document processing completed:', newHealthData);

                } catch (error) {
                    console.error('Error processing files:', error);
                } finally {
                    setTimeout(() => {
                        setIsProcessing(false);
                        setProcessingProgress(0);
                    }, 500);
                }
            };

            const handleDrop = useCallback((e) => {
                e.preventDefault();
                setDragOver(false);
                const files = Array.from(e.dataTransfer.files).filter(file => 
                    file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')
                );
                if (files.length > 0) {
                    handleFileUpload(files);
                }
            }, []);

            const handleDragOver = useCallback((e) => {
                e.preventDefault();
                setDragOver(true);
            }, []);

            const handleDragLeave = useCallback((e) => {
                e.preventDefault();
                setDragOver(false);
            }, []);

            const renderUpload = () => (
                <div className="max-w-4xl mx-auto">
                    <div className="text-center mb-8">
                        <h2 className="text-3xl font-bold text-gray-900 mb-4">Upload Your Health Documents</h2>
                        <p className="text-lg text-gray-600">
                            Drag and drop your lab reports or health documents for instant AI analysis
                        </p>
                    </div>

                    <div
                        className={`border-2 border-dashed rounded-lg p-8 text-center transition-all duration-300 ${
                            dragOver
                                ? 'border-blue-400 bg-blue-50'
                                : isProcessing
                                ? 'border-green-400 bg-green-50'
                                : 'border-gray-300 hover:border-gray-400'
                        } ${isProcessing ? 'upload-animation' : ''}`}
                        onDrop={handleDrop}
                        onDragOver={handleDragOver}
                        onDragLeave={handleDragLeave}
                    >
                        {isProcessing ? (
                            <div className="py-8">
                                <div className="processing-animation inline-block mb-4">
                                    <Brain className="h-12 w-12 text-blue-600" />
                                </div>
                                <h3 className="text-xl font-semibold text-gray-900 mb-2">
                                    AI Processing Your Health Data
                                </h3>
                                <p className="text-gray-600 mb-4">
                                    Analyzing patterns and generating insights...
                                </p>
                                <div className="w-full bg-gray-200 rounded-full h-2 mb-2">
                                    <div 
                                        className="bg-blue-600 h-2 rounded-full transition-all duration-300"
                                        style={{ width: `${processingProgress}%` }}
                                    ></div>
                                </div>
                                <p className="text-sm text-gray-500">{processingProgress}% Complete</p>
                            </div>
                        ) : (
                            <>
                                <Upload className="h-12 w-12 text-gray-400 mx-auto mb-4" />
                                <h3 className="text-xl font-semibold text-gray-900 mb-2">
                                    {dragOver ? 'Drop your files here!' : 'Choose files or drag and drop'}
                                </h3>
                                <p className="text-gray-500 mb-4">PDF documents up to 25MB each</p>
                                <input
                                    type="file"
                                    multiple
                                    accept=".pdf"
                                    onChange={(e) => handleFileUpload(Array.from(e.target.files))}
                                    className="hidden"
                                    id="file-upload"
                                />
                                <label
                                    htmlFor="file-upload"
                                    className="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 cursor-pointer"
                                >
                                    Select Files
                                </label>
                            </>
                        )}
                    </div>

                    {/* Privacy Assurance */}
                    <div className="mt-8 bg-green-50 border border-green-200 rounded-lg p-6">
                        <div className="flex items-start">
                            <Shield className="h-6 w-6 text-green-600 mr-3 mt-0.5" />
                            <div>
                                <h4 className="text-lg font-semibold text-green-800 mb-2">Your Privacy is Protected</h4>
                                <ul className="text-sm text-green-700 space-y-1">
                                    <li>• All processing happens locally in your browser</li>
                                    <li>• Personal identifiers are automatically removed</li>
                                    <li>• No health data is sent to external servers</li>
                                    <li>• Analysis results are stored securely on your device</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            );

            const renderResults = () => {
                if (!analysisResults && healthData.length === 0) {
                    return (
                        <div className="text-center py-12">
                            <FileText className="h-12 w-12 text-gray-400 mx-auto mb-4" />
                            <h3 className="text-xl font-semibold text-gray-900 mb-2">No Analysis Results</h3>
                            <p className="text-gray-500">Upload a health document to see AI-generated insights</p>
                        </div>
                    );
                }

                const latestResult = analysisResults || healthData[healthData.length - 1];
                
                return (
                    <div className="max-w-6xl mx-auto space-y-6">
                        {/* Analysis Header */}
                        <div className="bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg text-white p-6">
                            <div className="flex items-center justify-between">
                                <div>
                                    <h2 className="text-2xl font-bold mb-2">Health Analysis Complete</h2>
                                    <p className="text-blue-100">Document: {latestResult.fileName}</p>
                                    <p className="text-blue-100 text-sm">
                                        Processed: {new Date(latestResult.uploadDate).toLocaleString()}
                                    </p>
                                </div>
                                <div className="text-right">
                                    <div className="text-3xl font-bold">{Object.keys(latestResult.metrics).length}</div>
                                    <div className="text-blue-100">Metrics Analyzed</div>
                                </div>
                            </div>
                        </div>

                        {/* Health Metrics Grid */}
                        {Object.keys(latestResult.metrics).length > 0 && (
                            <div>
                                <h3 className="text-xl font-semibold text-gray-900 mb-4">📊 Health Metrics</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                                    {Object.entries(latestResult.metrics).map(([metric, data]) => (
                                        <div key={metric} className="bg-white rounded-lg border p-4 hover:shadow-md transition-shadow">
                                            <div className="flex items-center justify-between mb-2">
                                                <h4 className="font-semibold text-gray-900 text-sm">{metric}</h4>
                                                {metric.toLowerCase().includes('cholesterol') && <Heart className="h-4 w-4 text-red-500" />}
                                                {metric.toLowerCase().includes('glucose') && <Zap className="h-4 w-4 text-yellow-500" />}
                                                {metric.toLowerCase().includes('pressure') && <Activity className="h-4 w-4 text-blue-500" />}
                                            </div>
                                            <div className="text-2xl font-bold text-gray-900 mb-1">
                                                {data.value} <span className="text-sm font-normal text-gray-500">{data.unit}</span>
                                            </div>
                                            <div className="text-xs text-gray-500">
                                                Normal: {data.normal_range}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* AI Insights */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div className="bg-white rounded-lg border p-6">
                                <div className="flex items-center mb-4">
                                    <Brain className="h-6 w-6 text-purple-600 mr-2" />
                                    <h3 className="text-xl font-semibold text-gray-900">AI Insights</h3>
                                </div>
                                <div className="space-y-3">
                                    {latestResult.insights.map((insight, index) => (
                                        <div key={index} className="flex items-start">
                                            <CheckCircle className="h-5 w-5 text-green-500 mr-2 mt-0.5 flex-shrink-0" />
                                            <p className="text-gray-700">{insight}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="bg-white rounded-lg border p-6">
                                <div className="flex items-center mb-4">
                                    <AlertTriangle className="h-6 w-6 text-orange-600 mr-2" />
                                    <h3 className="text-xl font-semibold text-gray-900">Recommendations</h3>
                                </div>
                                <div className="space-y-3">
                                    {latestResult.recommendations.length > 0 ? (
                                        latestResult.recommendations.map((rec, index) => (
                                            <div key={index} className="flex items-start">
                                                <ArrowUpRight className="h-5 w-5 text-blue-500 mr-2 mt-0.5 flex-shrink-0" />
                                                <p className="text-gray-700">{rec}</p>
                                            </div>
                                        ))
                                    ) : (
                                        <p className="text-gray-500 italic">No specific recommendations at this time. Continue monitoring your health metrics.</p>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Processing Stats */}
                        <div className
