<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthAI - Privacy-First Health Analysis</title>
    <meta name="description" content="AI-powered health document analysis with complete privacy protection. Anonymous processing, instant insights.">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü©∫</text></svg>">
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">
                ü©∫ HealthAI
            </h1>
            <p class="text-lg text-gray-600 mb-4">
                Privacy-First Health Document Analysis
            </p>
            <div class="bg-green-100 border border-green-300 rounded-lg p-3 inline-block">
                <span class="text-green-800 font-medium">üîí Your identity never leaves your device ‚Ä¢ ‚ö° 3-second analysis ‚Ä¢ üåç Global edge processing</span>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Upload Health Document</h2>
            
            <!-- Upload Area - Thinner design -->
            <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center bg-gray-50 hover:bg-gray-100 transition-colors">
                <div class="flex items-center justify-center gap-6">
                    <div class="text-4xl">üìÅ</div>
                    <div class="flex-1 text-left">
                        <h3 class="text-lg font-semibold text-gray-700 mb-1">Drop Any Health Document Here</h3>
                        <div class="flex flex-wrap gap-2 text-sm text-gray-600 mb-2">
                            <span>üß™ Lab Results</span>
                            <span>‚Ä¢</span>
                            <span>ü¶¥ DEXA/Bone Density</span>
                            <span>‚Ä¢</span>
                            <span>üß¨ Hormone Panels</span>
                            <span>‚Ä¢</span>
                            <span>üèÉ Fitness Reports</span>
                            <span>‚Ä¢</span>
                            <span>ü©∏ Blood Work</span>
                            <span>‚Ä¢</span>
                            <span>‚öñÔ∏è Body Composition</span>
                        </div>
                        <p class="text-xs text-gray-500">
                            Maximum file size: 25MB ‚Ä¢ Format: PDF with readable text
                        </p>
                    </div>
                    <button id="uploadBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                        Choose File
                    </button>
                </div>
            </div>

            <input type="file" id="fileInput" accept=".pdf" class="hidden">
            
            <!-- Processing Status -->
            <div id="processingStatus" class="hidden mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <div class="flex items-center justify-center gap-3">
                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                    <span class="text-blue-800 font-medium">Processing your document...</span>
                </div>
                <div class="mt-2 text-sm text-blue-600 text-center">
                    üîí Anonymous processing ‚Ä¢ ‚ö° Results in ~3 seconds
                </div>
            </div>

            <!-- Error Display -->
            <div id="errorDisplay" class="hidden mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                <div class="flex items-start gap-3">
                    <span class="text-red-500 text-xl">‚ùå</span>
                    <div class="flex-1">
                        <h3 class="font-medium text-red-800">Document Processing Failed</h3>
                        <p id="errorMessage" class="text-red-700 mt-1"></p>
                        <div class="mt-2 text-sm text-red-600">
                            <strong>Common solutions:</strong>
                            <ul class="list-disc list-inside mt-1">
                                <li>Ensure PDF contains readable text (not scanned images)</li>
                                <li>Verify document contains numerical health values</li>
                                <li>Check file size is under 25MB</li>
                                <li>Make sure file is a valid PDF</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="hidden">
            <!-- Quick Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow-lg p-6 text-center">
                    <div class="text-3xl font-bold text-blue-600" id="parameterCount">0</div>
                    <div class="text-gray-600">Health Parameters</div>
                </div>
                <div class="bg-white rounded-lg shadow-lg p-6 text-center">
                    <div class="text-3xl font-bold text-green-600" id="processingTime">~3s</div>
                    <div class="text-gray-600">Processing Time</div>
                </div>
                <div class="bg-white rounded-lg shadow-lg p-6 text-center">
                    <div class="text-3xl font-bold text-purple-600">üîí</div>
                    <div class="text-gray-600">Privacy Protected</div>
                </div>
            </div>

            <!-- Health Parameters -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">üìä Extracted Health Data</h3>
                <div id="healthParameters" class="space-y-3">
                    <!-- Parameters will be inserted here -->
                </div>
            </div>

            <!-- AI Analysis -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">üß† AI Health Analysis</h3>
                <div id="aiAnalysis" class="prose max-w-none">
                    <!-- AI analysis will be inserted here -->
                </div>
            </div>

            <!-- Medical Context -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">üìö Medical Context & Resources</h3>
                <div id="medicalContext" class="space-y-4">
                    <!-- Medical context will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Privacy Notice -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
            <h3 class="text-lg font-medium text-blue-800 mb-2">üîí Your Privacy is Protected</h3>
            <div class="text-blue-700 space-y-2">
                <p>‚Ä¢ <strong>Anonymous Processing:</strong> Your personal identity never leaves your device</p>
                <p>‚Ä¢ <strong>Edge AI:</strong> Analysis happens on secure global servers for seconds only</p>
                <p>‚Ä¢ <strong>No Data Storage:</strong> All processing data is automatically purged within 30 seconds</p>
                <p>‚Ä¢ <strong>GDPR Compliant:</strong> Anonymous data processing exceeds all privacy requirements</p>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center mb-4">
            <span class="text-xs text-gray-400">HealthAI v2.0 - Build 10</span>
        </div>
        <div class="text-center text-sm text-gray-500">
            Powered by Cloudflare Workers AI ‚Ä¢ 
            <a href="https://analysemyhealth.com" class="text-blue-600 hover:underline">analysemyhealth.com</a>
        </div>
    </div>

    <script>
        console.log('=== HEALTHAI BUILD 10 INITIALIZATION ===');
        
        // Global variables
        let currentInput = '';
        
        // DOM elements
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const processingStatus = document.getElementById('processingStatus');
        const errorDisplay = document.getElementById('errorDisplay');
        const errorMessage = document.getElementById('errorMessage');
        const resultsSection = document.getElementById('resultsSection');
        const parameterCount = document.getElementById('parameterCount');
        const processingTime = document.getElementById('processingTime');
        const healthParameters = document.getElementById('healthParameters');
        const aiAnalysis = document.getElementById('aiAnalysis');
        const medicalContext = document.getElementById('medicalContext');

        // Event listeners
        uploadBtn.addEventListener('click', () => {
            console.log('Upload button clicked');
            fileInput.click();
        });

        fileInput.addEventListener('change', handleFileUpload);

        // Handle file upload
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                console.log('No file selected');
                return;
            }

            console.log('File selected:', file.name, 'Size:', file.size, 'Type:', file.type);

            // Validate file
            if (!file.type.includes('pdf') && !file.name.toLowerCase().includes('.pdf')) {
                showError('Please upload a PDF file only.');
                return;
            }

            if (file.size > 25 * 1024 * 1024) {
                showError('File size must be under 25MB.');
                return;
            }

            // Hide previous results and errors
            hideError();
            hideResults();
            showProcessing();

            try {
                console.log('Starting document processing...');
                const startTime = Date.now();

                // Step 1: Extract health data
                console.log('Step 1: Extracting health data from PDF...');
                const extractionData = await extractHealthData(file);
                
                if (!extractionData.success) {
                    throw new Error(extractionData.error || 'Extraction failed');
                }

                if (!extractionData.healthParameters || extractionData.healthParameters.length === 0) {
                    throw new Error('No health parameters found in the document. Please ensure your PDF contains lab results, measurements, or other numerical health data.');
                }

                console.log('Extraction successful, found', extractionData.healthParameters.length, 'parameters');

                // Step 2: AI Analysis
                console.log('Step 2: Getting AI analysis...');
                const analysisData = await getAIAnalysis(extractionData.healthParameters);
                
                if (!analysisData.success) {
                    throw new Error(analysisData.error || 'Analysis failed');
                }

                // Step 3: Get medical context
                console.log('Step 3: Getting medical context...');
                const contextData = await getMedicalContext(extractionData.healthParameters);

                const endTime = Date.now();
                const processingTimeMs = endTime - startTime;
                
                console.log('Processing completed in', processingTimeMs, 'ms');

                // Display results
                hideProcessing();
                displayResults({
                    healthParameters: extractionData.healthParameters,
                    aiAnalysis: analysisData.analysis,
                    medicalContext: contextData.context || [],
                    processingTimeMs: processingTimeMs
                });

            } catch (error) {
                console.error('Processing error:', error);
                hideProcessing();
                showError(`Error: ${error.message}`);
            }
        }

        // Extract health data from PDF
        async function extractHealthData(file) {
            try {
                console.log('Calling /api/extract with file:', file.name);
                
                const formData = new FormData();
                formData.append('pdfFile', file);

                const response = await fetch('/api/extract', {
                    method: 'POST',
                    body: formData
                });

                console.log('Extract API response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Extract API error response:', errorText);
                    throw new Error(`Server error: ${response.status}`);
                }

                const data = await response.json();
                console.log('Extract API response data:', data);
                
                return data;

            } catch (error) {
                console.error('Extract API call failed:', error);
                throw new Error(`Document extraction failed: ${error.message}`);
            }
        }

        // Get AI analysis
        async function getAIAnalysis(healthParameters) {
            try {
                console.log('Calling /api/analyze with', healthParameters.length, 'parameters');
                
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        healthParameters: healthParameters
                    })
                });

                console.log('Analyze API response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Analyze API error response:', errorText);
                    throw new Error(`Analysis server error: ${response.status}`);
                }

                const data = await response.json();
                console.log('Analyze API response data:', data);
                
                return data;

            } catch (error) {
                console.error('Analyze API call failed:', error);
                throw new Error(`AI analysis failed: ${error.message}`);
            }
        }

        // Get medical context
        async function getMedicalContext(healthParameters) {
            try {
                console.log('Calling /api/context with', healthParameters.length, 'parameters');
                
                const response = await fetch('/api/context', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        healthParameters: healthParameters
                    })
                });

                console.log('Context API response status:', response.status);
                
                if (!response.ok) {
                    console.log('Context API failed, continuing without medical context');
                    return { context: [] };
                }

                const data = await response.json();
                console.log('Context API response data:', data);
                
                return data;

            } catch (error) {
                console.error('Context API call failed:', error);
                // Don't fail the whole process if context fails
                return { context: [] };
            }
        }

        // Display functions
        function showProcessing() {
            processingStatus.classList.remove('hidden');
        }

        function hideProcessing() {
            processingStatus.classList.add('hidden');
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorDisplay.classList.remove('hidden');
        }

        function hideError() {
            errorDisplay.classList.add('hidden');
        }

        function hideResults() {
            resultsSection.classList.add('hidden');
        }

        function displayResults(data) {
            console.log('Displaying results:', data);

            // Update stats
            parameterCount.textContent = data.healthParameters.length;
            processingTime.textContent = `${(data.processingTimeMs / 1000).toFixed(1)}s`;

            // Display health parameters
            healthParameters.innerHTML = '';
            data.healthParameters.forEach((param, index) => {
                const paramDiv = document.createElement('div');
                paramDiv.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                paramDiv.innerHTML = `
                    <div class="flex-1">
                        <div class="font-medium text-gray-800">${escapeHtml(param.name)}</div>
                        <div class="text-sm text-gray-600">${escapeHtml(param.category || 'Health Parameter')}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-blue-600">${escapeHtml(param.value)}</div>
                        ${param.date ? `<div class="text-xs text-gray-500">${escapeHtml(param.date)}</div>` : ''}
                    </div>
                `;
                healthParameters.appendChild(paramDiv);
            });

            // Display AI analysis
            if (data.aiAnalysis) {
                aiAnalysis.innerHTML = `
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded">
                        <div class="whitespace-pre-wrap">${escapeHtml(data.aiAnalysis)}</div>
                    </div>
                `;
            } else {
                aiAnalysis.innerHTML = '<p class="text-gray-500">No AI analysis available.</p>';
            }

            // Display medical context
            if (data.medicalContext && data.medicalContext.length > 0) {
                medicalContext.innerHTML = '';
                data.medicalContext.forEach(context => {
                    const contextDiv = document.createElement('div');
                    contextDiv.className = 'p-4 bg-green-50 border border-green-200 rounded-lg';
                    contextDiv.innerHTML = `
                        <h4 class="font-medium text-green-800 mb-2">${escapeHtml(context.title || 'Medical Information')}</h4>
                        <p class="text-green-700">${escapeHtml(context.content || context.description || 'No description available')}</p>
                        ${context.url ? `<a href="${escapeHtml(context.url)}" target="_blank" class="text-green-600 hover:underline text-sm">Learn more ‚Üí</a>` : ''}
                    `;
                    medicalContext.appendChild(contextDiv);
                });
            } else {
                medicalContext.innerHTML = '<p class="text-gray-500">No additional medical context available.</p>';
            }

            // Show results section
            resultsSection.classList.remove('hidden');
            
            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        // Utility function to escape HTML
        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') {
                return String(unsafe);
            }
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        console.log('HealthAI Build 10 initialized successfully');
    </script>
</body>
</html>
